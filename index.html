<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Extractor de Coordenadas MINA MIRADOR</title>

  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Merriweather:wght@700&display=swap" rel="stylesheet"/>

  <!-- Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <!-- SortableJS para drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root {
      --azul-logo: #0f3d54;
      --naranja-logo: #b3611f;
      --texto: var(--azul-logo);
      --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --font-heading: 'Merriweather', serif;
      --radio: 6px;
      --shadow: 0 8px 24px rgba(15, 61, 84, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--font-sans);
      color: var(--texto);
      background: #fff;
      margin: 0;
      padding: 1.5rem 1rem;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.4;
    }
    header {
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }
    .logo { max-height: 70px; width: auto; flex-shrink: 0; }
    .title-block { display: flex; flex-direction: column; gap: 4px; }
    .title-main {
      display: flex; align-items: center; gap: 10px; margin: 0;
      font-family: var(--font-heading); font-size: 1.9rem; font-weight: 700;
    }
    .badge {
      background: var(--naranja-logo); padding: 4px 10px;
      border-radius: 4px; color: #fff; font-size: 0.85rem;
      font-weight: 600; display: inline-block;
    }
    .subtitle { font-size: 0.95rem; margin: 0; font-weight: 500; }
    .controls { display: flex; gap: .75rem; flex-wrap: wrap; margin-top: 0.5rem; }
    input[type="file"] {
      border: 1px solid #d1d5db; padding: 0.45rem 0.75rem;
      border-radius: 5px; font-size: 0.9rem;
    }
    button {
      cursor: pointer; border: none; border-radius: var(--radio);
      padding: 0.55rem 1rem; font-size: 0.9rem; font-weight: 600;
      font-family: var(--font-sans); transition: filter .15s;
      box-shadow: var(--shadow); margin-right: .25rem;
    }
    #processBtn { background: var(--azul-logo); color: #fff; }
    #processBtn:hover { filter: brightness(1.05); }
    #downloadBtn {
      background: #1f8f4b; color: #fff;
    }
    #downloadBtn:disabled {
      opacity: 0.5; cursor: not-allowed;
    }
    #status { margin-top: 0.75rem; font-size: 0.9rem; font-weight: 500; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 1rem;
      font-size: 0.85rem; background: #fff;
      border-radius: 6px; overflow: hidden;
      box-shadow: 0 12px 32px rgba(15, 61, 84, 0.06);
    }
    th, td {
      padding: 0.55rem 0.65rem; text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    thead { background: #f5f7fa; }
    th {
      font-weight: 600; position: sticky; top: 0;
    }
    tr:last-child td { border-bottom: none; }
    tbody tr { cursor: grab; } /* indicador de que es arrastrable */
    @media (max-width: 840px) {
      .title-main { font-size: 1.6rem; }
      header { gap: 0.5rem; }
      .controls { flex-direction: column; align-items: stretch; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo_lab_chino_PNG.png" alt="Logo LSM Mina Mirador" class="logo" />
    <div class="title-block">
      <div class="title-main">
        Extractor de Coordenadas
        <span class="badge">LSM MINA MIRADOR</span>
      </div>
      <div class="subtitle">Laboratorio de Suelos y Materiales</div>
    </div>
  </header>

  <div class="controls">
    <input type="file" id="fileInput" accept="image/*" multiple />
    <button id="processBtn">Procesar Imágenes</button>
    <button id="downloadBtn" disabled>Descargar Excel</button>
  </div>
  <div id="status"></div>

  <table id="resultsTable">
    <thead>
      <tr>
        <th>Archivo</th>
        <th>E</th>
        <th>N</th>
        <th>Elevation</th>
        <th>ABS</th>
        <th>Stn</th>
        <th>Nombre Punto</th>
        <th>Código</th>
        <th>STK</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const patterns = {
      N: /N\s*[:=]?\s*(\d+\.\d+)/i,
      E: /E\s*[:=]?\s*(\d+\.\d+)/i,
      Elevation: /Elevation\s*[:=]?\s*(\d+\.\d+)/i,
      Stn: /Stn[:=]?\s*([A-Za-z0-9\+\-\.]+)/i
    };

    let resultsGlobal = [];

    function truncar(val) {
      const f = parseFloat(val);
      if (isNaN(f)) return val;
      return (Math.floor(f * 100) / 100).toFixed(2);
    }

    function extractData(text) {
      const datos = {
        Archivo: '',
        N: '-',
        E: '-',
        Elevation: '-',
        ABS: '-',
        'Nombre Punto': '-',
        Código: '-',
        STK: '-',
        Stn: '-'
      };

      // 1. Buscar coordenadas tipo "781742, 9602780"
      const coordMatch = text.match(/(\d{6,}),\s*(\d{6,})/);
      if (coordMatch) {
        datos.E = coordMatch[1];
        datos.N = coordMatch[2];
      }

      // 2. Buscar código en líneas con patrón esperado o después de "Nombre"
      const lines = text.split(/\r?\n/);
      let foundCodigo = false;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();

        // Si la línea es "Nombre", toma la siguiente como código si es válida
        if (!foundCodigo && /^nombre$/i.test(line) && lines[i + 1]) {
          const nextLine = lines[i + 1].trim();
          if (
            nextLine.length > 0 &&
            !/editar|done|save|agregar|actual|capa|layer|coordenadas|coordinates|fotos|descripción|estilo|elevación/i.test(nextLine)
          ) {
            datos.Código = nextLine;
            foundCodigo = true;
            continue;
          }
        }

        // Buscar patrón tipo "Zona 2 - M11", "M5 -", "GTM5 -gtm4"
        if (!foundCodigo) {
          const codeMatch = line.match(/([A-Za-z0-9]+(?:\s+[A-Za-z0-9]+)*\s*-\s*[A-Za-z0-9]+(?:\s+[A-Za-z0-9]+)*)/);
          if (codeMatch && codeMatch[0].trim().length > 2) {
            datos.Código = codeMatch[0].trim();
            foundCodigo = true;
            continue;
          }
        }

        // También acepta nombres simples como "M5" o "Zona 6" si no hay guion
        if (
          !foundCodigo &&
          /^[A-Za-z0-9\s]{2,20}$/.test(line) &&
          !/editar|done|save|agregar|actual|capa|layer|coordenadas|coordinates|fotos|descripción|estilo|elevación/i.test(line)
        ) {
          datos.Código = line;
          foundCodigo = true;
          // No continue, por si hay un mejor match más adelante
        }
      }

      // 3. Si no se encontró, busca en todo el texto
      if (datos.Código === '-') {
        const codeMatch = text.match(/([A-Za-z0-9]+(?:\s+[A-Za-z0-9]+)*\s*-\s*[A-Za-z0-9]+(?:\s+[A-Za-z0-9]+)*)/);
        if (codeMatch && codeMatch[0].trim().length > 2) {
          datos.Código = codeMatch[0].trim();
        }
      }

      // 4. Patrones originales
      Object.keys(patterns).forEach(key => {
        const m = text.match(patterns[key]);
        if (m) datos[key] = truncar(m[1]);
      });

      lines.forEach(line => {
        if (line.includes('STK_')) {
          const parts = line.trim().split(/\s+/);
          datos['Nombre Punto'] = parts[0];
          if (parts.length > 1) datos['Código'] = parts.slice(1).join(' ');
        }
      });

      if (datos['STK'] === '-') {
        datos.STK = `${datos['Nombre Punto']} ${datos.Código}`.trim();
      }

      const m_abs = typeof datos.Stn === 'string' ? datos.Stn.match(/K([+-]?\d+)\+(\d+\.\d+)/) : null;
      if (m_abs) {
        const kmText = m_abs[1];
        const kmVal   = parseInt(kmText, 10);
        const kmAbs   = Math.abs(kmVal);
        const metres  = parseFloat(m_abs[2]);
        const sign    = kmText.startsWith('-') ? -1 : 1;
        const total   = (kmAbs * 100 + metres) * sign;
        datos.ABS     = (Math.trunc(total * 100) / 100).toFixed(2);
      }
      return datos;
    }
    async function processFiles(files) {
      resultsGlobal = [];
      document.querySelector('#resultsTable tbody').innerHTML = '';
      document.getElementById('status').innerText = '';
      for (let file of files) {
        document.getElementById('status').innerText = `Procesando ${file.name}...`;
        try {
          const { data: { text } } = await Tesseract.recognize(file, 'spa');
          const datos = extractData(text);
          datos.Archivo = file.name;
          resultsGlobal.push(datos);
          appendRow(datos);
        } catch {
          appendRow({
            Archivo: file.name,
            N: 'ERROR', E: 'ERROR', Elevation: 'ERROR',
            ABS: 'ERROR', Stn: 'ERROR',
            'Nombre Punto': 'ERROR', Código: 'ERROR', STK: 'ERROR'
          });
        }
      }
      document.getElementById('status').innerText = 'Procesamiento completado.';
      document.getElementById('downloadBtn').disabled = false;
    }

    function appendRow(datos) {
      const tbody = document.querySelector('#resultsTable tbody');
      const tr = document.createElement('tr');
      ['Archivo','E','N','Elevation','ABS','Stn','Nombre Punto','Código','STK']
        .forEach(key => {
          const td = document.createElement('td');
          td.innerText = datos[key] || '';
          tr.appendChild(td);
        });
      tbody.appendChild(tr);
    }

    // Inicializa SortableJS en el <tbody>
    Sortable.create(document.querySelector('#resultsTable tbody'), {
      animation: 150,
      ghostClass: 'sortable-ghost',
      onEnd: () => syncResultsGlobal()
    });

    function syncResultsGlobal() {
      const filas = document.querySelectorAll('#resultsTable tbody tr');
      resultsGlobal = Array.from(filas).map(tr => {
        const c = tr.querySelectorAll('td');
        return {
          Archivo:   c[0].innerText,
          E:         c[1].innerText,
          N:         c[2].innerText,
          Elevation: c[3].innerText,
          ABS:       c[4].innerText,
          Stn:       c[5].innerText,
          'Nombre Punto': c[6].innerText,
          Código:    c[7].innerText,
          STK:       c[8].innerText
        };
      });
    }

function downloadExcel() {
  // 1) Asegúrate de que el array global está sincronizado
  syncResultsGlobal();

  // 2) Mapea a un nuevo array donde N, E, Elevation y ABS sean números
  const dataNumeric = resultsGlobal.map(r => ({
    Archivo:       r.Archivo,
    E:             parseFloat(r.E)         || null,
    N:             parseFloat(r.N)         || null,
    Elevation:     parseFloat(r.Elevation) || null,
    ABS:           parseFloat(r.ABS)       || null,
    Stn:           r.Stn,
    'Nombre Punto': r['Nombre Punto'],
    Código:        r.Código,
    STK:           r.STK
  }));

  // 3) Genera la hoja pasando raw:true
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(dataNumeric, {
    header: ['Archivo','E','N','Elevation','ABS','Stn','Nombre Punto','Código','STK'],
    raw: true
  });
  XLSX.utils.book_append_sheet(wb, ws, 'Datos');

  // 4) Escribe el archivo
  XLSX.writeFile(wb, 'datos_extraidos.xlsx');
}

    document.getElementById('processBtn')
      .addEventListener('click', () => {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return alert('Selecciona al menos una imagen');
        processFiles(files);
      });

    document.getElementById('downloadBtn')
      .addEventListener('click', downloadExcel);
  </script>
</body>
</html>